<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Air Quality Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.7.0/ol.css" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        background: radial-gradient(circle at top, #0b1220 0, #020617 55%);
        color: #e5e7eb;
      }
      h1 {
        margin-bottom: 0.25rem;
        font-size: 1.75rem;
        letter-spacing: 0.02em;
      }
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.25rem;
      }
      .brand-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: radial-gradient(circle at top left, #06b6d4, #22c55e);
        color: #0b1120;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 12px 30px rgba(6, 182, 212, 0.5);
      }
      .brand-icon {
        width: 20px;
        height: 20px;
        border-radius: 999px;
        border: 2px solid rgba(15, 23, 42, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 800;
      }
      .status {
        font-size: 0.9rem;
        color: #38bdf8;
      }
      .error {
        color: #f87171;
      }
      .card {
        max-width: none;
        margin: 1.75rem 1.5rem 2.25rem;
        background: radial-gradient(circle at top left, #0b1729 0, #020617 55%);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        box-shadow: 0 32px 80px rgba(15, 23, 42, 0.9);
      }
      .map-wrapper {
        position: relative;
        margin-top: 0.5rem;
      }
      #map {
        height: calc(100vh - 260px);
        min-height: 380px;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      .controls select,
      .controls button {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        padding: 0.25rem 0.9rem;
        font-size: 0.9rem;
      }
      .controls select:focus,
      .controls button:focus {
        outline: 2px solid #22d3ee;
        outline-offset: 1px;
      }
      .controls button#reload {
        background: linear-gradient(135deg, #06b6d4, #22c55e);
        border: none;
        color: #0b1120;
        font-weight: 600;
        box-shadow: 0 12px 30px rgba(6, 182, 212, 0.45);
      }
      .controls button#reload:hover {
        filter: brightness(1.05);
      }
      .locate-btn {
        position: absolute;
        top: 0.75rem;
        left: 3.25rem;
        z-index: 21;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
        padding: 0.15rem 0.65rem;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .locate-btn:hover {
        background: rgba(30, 64, 175, 0.95);
      }
      .ts-panel {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 760px;
        max-width: calc(100% - 1.5rem);
        max-height: 420px;
        background: #020617;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 0.75rem 1rem 0.75rem;
        box-shadow: 0 28px 70px rgba(15, 23, 42, 0.9);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
        transition: transform 220ms ease-out, opacity 220ms ease-out;
        z-index: 20;
        overflow: hidden;
      }
      .ts-panel.open {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
      }
      .ts-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.25rem;
      }
      .ts-panel-title {
        font-size: 1rem;
        font-weight: 600;
      }
      .ts-panel-close {
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 1.1rem;
        cursor: pointer;
      }
      #ts-chart {
        width: 100%;
        max-width: 760px;
        height: 220px;
        display: block;
      }
      @media (max-width: 900px) {
        #map {
          height: calc(100vh - 300px);
          min-height: 300px;
        }
        .locate-btn {
          top: 0.6rem;
          left: 3.1rem;
          font-size: 0.75rem;
        }
        .ts-panel {
          width: calc(100% - 1.5rem);
          right: 0.75rem;
          max-height: 65vh;
        }
        #ts-chart {
          height: 220px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="card-header">
        <h1>European Air Quality Demo</h1>
        <a
          href="https://naviodev.com"
          target="_blank"
          rel="noreferrer"
          class="brand-link"
        >
          <span class="brand-icon">N</span>
          <span>Back to NavioDev</span>
        </a>
      </div>
      <p class="status" id="status">Loading data...</p>
      <div class="controls">
        <label>Country:
          <select id="country">
            <option value="">All</option>
            <option value="DE">DE</option>
            <option value="NL">NL</option>
            <option value="PL">PL</option>
          </select>
        </label>
        <label>Pollutant:
          <select id="pollutant">
            <option value="">All</option>
            <option value="pm10">pm10</option>
            <option value="pm25">pm25</option>
            <option value="no2">no2</option>
            <option value="o3">o3</option>
            <option value="nox">nox</option>
            <option value="no">no</option>
          </select>
        </label>
        <button id="reload">Reload</button>
      </div>
      <div class="map-wrapper">
        <button id="locate-me" class="locate-btn" type="button">My location</button>
        <div id="map"></div>
        <div id="ts-panel" class="ts-panel">
          <div class="ts-panel-header">
            <div class="ts-panel-title" id="ts-title">Time series</div>
            <button id="ts-close" class="ts-panel-close" aria-label="Close">&times;</button>
          </div>
          <p id="ts-status" class="status" style="margin-bottom:0.5rem;">Click a station on the map to load a chart.</p>
          <canvas id="ts-chart"></canvas>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v10.7.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      const statusEl = document.getElementById("status");
      const countryEl = document.getElementById("country");
      const pollutantEl = document.getElementById("pollutant");
      const reloadBtn = document.getElementById("reload");
      const tsPanel = document.getElementById("ts-panel");
      const tsTitleEl = document.getElementById("ts-title");
      const tsCloseBtn = document.getElementById("ts-close");
      const tsStatusEl = document.getElementById("ts-status");
      const tsCanvas = document.getElementById("ts-chart");
      const locateBtn = document.getElementById("locate-me");

      const wktFormat = new ol.format.WKT();
      const stationsSource = new ol.source.Vector();
      const userLocationSource = new ol.source.Vector();

      const POLLUTANT_THRESHOLDS = {
        pm25: [10, 25, 50],
        pm10: [20, 50, 100],
        no2: [40, 100, 200],
        o3: [60, 120, 180],
        nox: [100, 200, 400],
        no: [50, 100, 200],
        co: [2, 4, 8],
        so2: [20, 75, 185],
      };

      function getColorForValue(pollutant, value) {
        if (value == null) return "#3b82f6";
        const key = (pollutant || "").toLowerCase();
        const t = POLLUTANT_THRESHOLDS[key] || [25, 50, 75];
        if (value <= t[0]) return "#22c55e"; // green
        if (value <= t[1]) return "#eab308"; // yellow
        if (value <= t[2]) return "#f97316"; // orange
        return "#ef4444"; // red
      }

      const MAIN_POLLUTANTS = ["pm25", "pm10", "no2", "o3"];

      function pickPrimaryMeasurement(measurements) {
        if (!Array.isArray(measurements) || !measurements.length) return null;
        const selected = (pollutantEl.value || "").toLowerCase();
        if (selected) {
          const direct = measurements.find(
            (m) => (m.pollutant || "").toLowerCase() === selected
          );
          if (direct) return direct;
        }
        for (const p of MAIN_POLLUTANTS) {
          const m = measurements.find(
            (mm) => (mm.pollutant || "").toLowerCase() === p
          );
          if (m) return m;
        }
        return measurements[0];
      }

      function getFeatureColor(feature) {
        const meas = feature.get("measurements") || [];
        const primary = pickPrimaryMeasurement(meas);
        if (!primary) return "#3b82f6";
        return getColorForValue(
          (primary.pollutant || "").toLowerCase(),
          primary.value
        );
      }

      const clusterSource = new ol.source.Cluster({
        distance: 40,
        source: stationsSource,
      });

      const clusterLayer = new ol.layer.Vector({
        source: clusterSource,
        style: (feature) => {
          const features = feature.get("features");
          if (!features || !features.length) {
            return null;
          }
          if (features.length === 1) {
            const f = features[0];
            const color = getFeatureColor(f);
            return new ol.style.Style({
              image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({ color }),
                stroke: new ol.style.Stroke({
                  color: "#0f172a",
                  width: 1.5,
                }),
              }),
            });
          }
          // cluster style: average color by primary pollutant value
          let sum = 0;
          let count = 0;
          const firstMeas = features[0].get("measurements") || [];
          const primary = pickPrimaryMeasurement(firstMeas);
          const pollutantKey = (primary && primary.pollutant) || "";
          for (const f of features) {
            const ms = f.get("measurements") || [];
            const m = pickPrimaryMeasurement(ms);
            if (!m || m.value == null) continue;
            sum += m.value;
            count += 1;
          }
          const avg = count ? sum / count : null;
          const color = getColorForValue(pollutantKey, avg);
          const radius = 10 + Math.min(features.length, 20);
          return new ol.style.Style({
            image: new ol.style.Circle({
              radius,
              fill: new ol.style.Fill({ color }),
              stroke: new ol.style.Stroke({
                color: "#0f172a",
                width: 1.5,
              }),
            }),
            text: new ol.style.Text({
              text: String(features.length),
              fill: new ol.style.Fill({ color: "#0f172a" }),
              font: "bold 11px 'Segoe UI', sans-serif",
            }),
          });
        },
      });
      const map = new ol.Map({
        target: "map",
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM(),
          }),
          clusterLayer,
          new ol.layer.Vector({
            source: userLocationSource,
            style: new ol.style.Style({
              image: new ol.style.RegularShape({
                radius: 9,
                points: 4,
                angle: Math.PI / 4,
                fill: new ol.style.Fill({ color: "rgba(56, 189, 248, 0.9)" }),
                stroke: new ol.style.Stroke({
                  color: "#f9fafb",
                  width: 2,
                }),
              }),
            }),
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([10, 51]),
          zoom: 5,
        }),
      });

      // Navigation buttons styling (native controls)
      const zoomButtons = document.getElementsByClassName("ol-zoom")[0];
      if (zoomButtons) {
        zoomButtons.style.borderRadius = "8px";
        zoomButtons.style.overflow = "hidden";
      }

      locateBtn.addEventListener("click", () => {
        if (!navigator.geolocation) {
          statusEl.textContent = "Geolocation is not supported in this browser.";
          statusEl.classList.add("error");
          return;
        }
        statusEl.textContent = "Locating your position...";
        statusEl.classList.remove("error");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lon = pos.coords.longitude;
            const lat = pos.coords.latitude;
            const coord = ol.proj.fromLonLat([lon, lat]);
            userLocationSource.clear();
            const userFeature = new ol.Feature({
              geometry: new ol.geom.Point(coord),
            });
            userFeature.set("isUserLocation", true);
            userLocationSource.addFeature(userFeature);
            map.getView().animate({
              center: coord,
              zoom: 16,
              duration: 500,
            });
            statusEl.textContent = "Centered on your location";
          },
          () => {
            statusEl.textContent = "Unable to determine your location.";
            statusEl.classList.add("error");
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 600000,
          }
        );
      });

      let tsChart = null;

      function openTimeseriesPanel(title) {
        tsTitleEl.textContent = title;
        tsPanel.classList.add("open");
      }

      function closeTimeseriesPanel() {
        tsPanel.classList.remove("open");
        tsStatusEl.textContent = "Click a station on the map to load a chart.";
        tsStatusEl.classList.remove("error");
      }

      tsCloseBtn.addEventListener("click", closeTimeseriesPanel);

      async function fetchStationsWkt() {
        const params = new URLSearchParams();
        const country = countryEl.value;
        const pollutant = pollutantEl.value;
        if (country) params.append("country", country);
        if (pollutant) params.append("pollutant", pollutant);
        const resp = await fetch(`/api/stations_wkt?${params.toString()}`);
        if (!resp.ok) throw new Error("API error");
        return resp.json();
      }

      async function reload() {
        statusEl.textContent = "Loading data...";
        statusEl.classList.remove("error");
        try {
          const data = await fetchStationsWkt();
          stationsSource.clear(true);
          const feats = [];
          for (const item of data) {
            if (!item.wkt) continue;
            const feature = wktFormat.readFeature(item.wkt, {
              dataProjection: "EPSG:4326",
              featureProjection: "EPSG:3857",
            });
            feature.setProperties({
              station_id: item.station_id,
              country: item.country,
              location_name: item.location_name,
              measurements: item.measurements || [],
            });
            feats.push(feature);
          }
          stationsSource.addFeatures(feats);
          statusEl.textContent = `Real-time air quality from ${feats.length} stations`;
          if (feats.length) {
            const extent = stationsSource.getExtent();
            map.getView().fit(extent, { padding: [40, 40, 40, 40], duration: 300 });
          }
        } catch (e) {
          console.error(e);
          statusEl.textContent = "No data yet";
          statusEl.classList.add("error");
        }
      }

      reloadBtn.addEventListener("click", reload);
      // Popup on click
      const overlayEl = document.createElement("div");
      overlayEl.style.background = "rgba(15,23,42,0.92)";
      overlayEl.style.color = "#e2e8f0";
      overlayEl.style.padding = "10px 12px";
      overlayEl.style.borderRadius = "10px";
      overlayEl.style.border = "1px solid rgba(148, 163, 184, 0.35)";
      overlayEl.style.boxShadow = "0 8px 24px rgba(0,0,0,0.35)";
      overlayEl.style.minWidth = "180px";
      overlayEl.style.fontSize = "13px";
      const overlay = new ol.Overlay({
        element: overlayEl,
        autoPan: true,
        autoPanAnimation: { duration: 200 },
      });
      map.addOverlay(overlay);

      map.on("singleclick", (evt) => {
        const feature = map.forEachFeatureAtPixel(evt.pixel, (feat) => feat);
        if (!feature) {
          overlay.setPosition(undefined);
          return;
        }
        const inner = feature.get("features");
        const baseFeature =
          Array.isArray(inner) && inner.length ? inner[0] : feature;
        if (baseFeature.get("isUserLocation")) {
          overlay.setPosition(undefined);
          return;
        }
        const props = baseFeature.getProperties();
        const meas = Array.isArray(props.measurements) ? props.measurements : [];
        const activePollutant = pollutantEl.value || (meas[0] && meas[0].pollutant) || "";
        const rows = meas
          .map((m) => {
            const ts = m.timestamp ? new Date(m.timestamp).toLocaleString() : "";
            const val = m.value ?? "";
            const unit = m.unit || "";
            const isPrimary = activePollutant && m.pollutant === activePollutant;
            const weight = isPrimary ? "font-weight:600;" : "";
            const color = isPrimary ? "color:#e5e7eb;" : "color:#94a3b8;";
            return `<tr style="${weight}"><td>${m.pollutant || ""}</td><td style="text-align:right;${color}">${val} ${unit}</td><td style="color:#64748b;">${ts}</td></tr>`;
          })
          .join("");
        overlay.getElement().innerHTML = `
          <div style="font-weight:700;font-size:14px;margin-bottom:4px;">${props.location_name || props.station_id || ""}</div>
          <div style="margin-bottom:6px;color:#94a3b8;">${props.country || ""}</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead><tr><th style="text-align:left;">Pollutant</th><th style="text-align:right;">Value</th><th style="text-align:left;">Time</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
        overlay.setPosition(evt.coordinate);

        const titleParts = [];
        if (props.location_name) titleParts.push(String(props.location_name));
        if (props.country) titleParts.push(String(props.country));
        openTimeseriesPanel(
          titleParts.length ? titleParts.join(" òÀâ ") : "Time series"
        );
        loadTimeseries(props.station_id, activePollutant);
      });

      reload();

      async function fetchTimeseries(stationId, pollutant, hours = 24) {
        const params = new URLSearchParams({
          station_id: stationId,
          pollutant,
          hours: String(hours),
        });
        const resp = await fetch(`/api/measurements/timeseries?${params.toString()}`);
        if (!resp.ok) {
          throw new Error(`Timeseries API error: ${resp.status}`);
        }
        return resp.json();
      }

      async function loadTimeseries(stationId, primaryPollutant) {
        const base = (primaryPollutant || "").toLowerCase();
        const wanted = [];
        if (base) {
          wanted.push(base);
        }
        for (const p of MAIN_POLLUTANTS) {
          if (!wanted.includes(p)) {
            wanted.push(p);
          }
        }
        tsStatusEl.textContent = `Loading timeseries (${wanted.join(", ")})...`;
        tsStatusEl.classList.remove("error");
        try {
          const promises = wanted.map((p) =>
            fetchTimeseries(stationId, p).then(
              (series) => ({ pollutant: p, series }),
              () => null
            )
          );
          const results = (await Promise.all(promises)).filter(Boolean);
          if (!results.length) {
            tsStatusEl.textContent = "No timeseries data for this station.";
            tsStatusEl.classList.add("error");
            return;
          }
          const first = results[0].series;
          const labels = first.map((p) =>
            new Date(p.timestamp).toLocaleString()
          );

          const palette = [
            "#38bdf8",
            "#f97316",
            "#22c55e",
            "#8b5cf6",
            "#facc15",
          ];

          const datasets = results.map((r, idx) => {
            const values = r.series.map((p) => p.value);
            const unit = (r.series[0] && r.series[0].unit) || "ug/m3";
            const color = palette[idx % palette.length];
            return {
              label: `${r.pollutant} (${unit})`,
              data: values,
              borderColor: color,
              backgroundColor: color + "33",
              tension: 0.3,
              pointRadius: 2,
            };
          });

          const data = {
            labels,
            datasets,
          };
          const isNarrow = window.innerWidth < 640;
          const options = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            layout: {
              padding: {
                top: 8,
                right: 8,
                left: 8,
                bottom: isNarrow ? 90 : 60,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: "#9ca3af",
                  maxRotation: isNarrow ? 0 : 45,
                  autoSkip: true,
                  maxTicksLimit: isNarrow ? 4 : 8,
                  font: { size: isNarrow ? 9 : 11 },
                  display: true,
                },
                grid: { color: "rgba(55,65,81,0.5)" },
              },
              y: {
                ticks: {
                  color: "#9ca3af",
                  font: { size: isNarrow ? 9 : 11 },
                },
                grid: { color: "rgba(55,65,81,0.5)" },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: "#e5e7eb",
                  font: { size: isNarrow ? 9 : 11 },
                },
              },
            },
          };

          if (tsChart) {
            tsChart.data = data;
            tsChart.options = options;
            tsChart.update();
          } else {
            tsChart = new Chart(tsCanvas.getContext("2d"), {
              type: "line",
              data,
              options,
            });
          }
          tsStatusEl.textContent = `Pollutants: ${results
            .map((r) => r.pollutant)
            .join(", ")} (last 24 hours)`;
        } catch (e) {
          console.error(e);
          tsStatusEl.textContent = "Failed to load timeseries for this station.";
          tsStatusEl.classList.add("error");
        }
      }
    </script>
  </body>
</html>


